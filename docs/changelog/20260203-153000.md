# 自动同步日志可视化

**日期**: 2026-02-03 15:30:00

## 任务描述

用户反馈自动同步功能无法看到执行日志，无法确认定时任务是否正常运行。

## 根因分析

1. `scheduler.ts` 中的日志使用 `console.log`，只输出到主进程终端
2. 前端没有监听 scheduler 的日志事件
3. 缺少日志展示组件

## 实施方案

### 修改文件

1. **src/main/services/scheduler.ts**
   - 新增 `SchedulerLog` 接口定义日志结构
   - 新增 `sendSchedulerLog` 函数，通过 IPC 发送日志到前端
   - 替换所有 `console.log` 为 `sendSchedulerLog`

2. **src/preload/index.ts**
   - 新增 `schedulerAPI` 对象
   - 暴露 `onLog` 方法监听 `scheduler:log` 事件

3. **src/preload/index.d.ts**
   - 新增 `SchedulerLog` 接口类型
   - 新增 `SchedulerAPI` 接口类型
   - 在 `API` 接口中添加 `scheduler` 属性

4. **src/renderer/src/pages/settings/LogsPage.tsx** (新建)
   - 独立的日志页面组件
   - 支持按类型筛选（全部/用户同步/任务下载/系统）
   - 显示 info/warn/error 三种级别
   - 保留最近 500 条日志
   - 支持清空日志

5. **src/renderer/src/routes/index.tsx**
   - 新增 `/logs` 路由

6. **src/renderer/src/components/AppLayout.tsx**
   - 侧边栏新增「同步日志」入口

## 执行结果

- [x] 创建 IPC 通道，从主进程发送 scheduler 日志到前端
- [x] 修改 scheduler.ts，添加日志发送功能
- [x] 在 preload/index.ts 暴露日志监听 API
- [x] 创建独立的日志页面组件
- [x] 在路由中注册日志页面
- [x] 在侧边栏添加日志入口
- [x] TypeScript 编译验证通过

## 问题修复 (2026-02-03 续)

### 问题描述

用户反馈：同步已执行（终端有日志输出），但前端日志页面显示为空。

### 根因分析

日志页面仅监听实时 IPC 事件，若页面未打开，错过的日志无法恢复。

### 修复方案

1. **src/main/services/scheduler.ts**
   - 添加 `logBuffer` 数组存储最近 500 条日志
   - 新增 `getSchedulerLogs()` 和 `clearSchedulerLogs()` 函数

2. **src/main/index.ts**
   - 新增 IPC handlers: `scheduler:getLogs`, `scheduler:clearLogs`

3. **src/preload/index.ts**
   - schedulerAPI 新增 `getLogs` 和 `clearLogs` 方法

4. **src/preload/index.d.ts**
   - 更新 SchedulerAPI 接口，添加新方法签名

5. **src/renderer/src/pages/settings/LogsPage.tsx**
   - 组件挂载时调用 `getLogs()` 加载历史日志
   - 清空按钮同时调用后端 `clearLogs()` 清除缓冲区

### 验证结果

- [x] TypeScript 编译验证通过
